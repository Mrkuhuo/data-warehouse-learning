/*
 * 脚本名称: dws_traffic_session_page_view_1d_per_day.sql
 * 目标表: dws.dws_traffic_session_page_view_1d
 * 数据粒度: 会话 + 日期
 * 刷新策略: 增量刷新，每日新增数据
 * 调度周期: 每日调度一次
 * 运行参数:
 *   - pdate: 数据日期，默认为当天
 * 依赖表:
 *   - dwd.dwd_traffic_page_view_inc: 流量域页面浏览事实表
 */

-- 流量域会话粒度页面浏览最近1日汇总表
-- 计算逻辑: 
-- 1. 筛选出当日的页面浏览数据
-- 2. 按会话和日期分组聚合浏览数据
-- 3. 计算会话访问时长和页面浏览次数
INSERT INTO dws.dws_traffic_session_page_view_1d(
    /* 会话维度 */
    session_id,                        /* 会话ID: 标识用户一次访问会话 */
    mid_id,                            /* 设备ID: 访客唯一标识 */
    k1,                                /* 数据日期: 访问日期 */
    
    /* 设备信息维度 */
    brand,                             /* 设备品牌: 用户使用的设备品牌 */
    model,                             /* 设备型号: 用户使用的具体机型 */
    operate_system,                    /* 操作系统: 用户使用的系统类型 */
    
    /* 应用信息维度 */
    version_code,                      /* 应用版本: 用户使用的APP版本号 */
    channel,                           /* 下载渠道: APP的下载来源渠道 */
    
    /* 度量值字段 */
    during_time_1d,                    /* 访问时长: 会话在所有页面停留的总时长(秒) */
    page_count_1d                      /* 页面浏览数: 会话浏览的页面总数 */
)
SELECT
    /* 会话维度: 用于分析用户访问行为 */
    CONCAT(mid_id, '_', DATE_FORMAT(k1, '%Y%m%d'), '_', last_page_id) AS session_id,                       /* 会话ID: 用于追踪单次访问过程 */
    mid_id,                            /* 设备ID: 用于识别独立访客 */
    k1,                                /* 数据日期: 用于时间维度分析 */
    
    /* 设备信息维度: 用于分析不同设备的访问特征 */
    brand,                             /* 设备品牌: 分析不同品牌设备的使用情况 */
    model,                             /* 设备型号: 分析不同型号设备的使用情况 */
    operate_system,                    /* 操作系统: 分析不同系统的用户分布 */
    
    /* 应用信息维度: 用于分析不同版本和渠道的访问特征 */
    version_code,                      /* 应用版本: 分析不同版本的用户体验 */
    channel,                           /* 下载渠道: 评估不同渠道的用户质量 */
    
    /* 统计指标 */
    SUM(during_time) AS during_time_1d,  /* 访问时长: 汇总会话在所有页面的停留时长 */
    COUNT(*) AS page_count_1d            /* 页面浏览数: 统计会话浏览的页面数量 */
FROM 
    dwd.dwd_traffic_page_view_inc     /* 数据来源: 页面浏览明细事实表 */
WHERE 
    k1 = DATE('${pdate}')             /* 时间筛选: 只处理当天数据 */
GROUP BY 
    session_id, mid_id, k1,            /* 按会话和日期分组 */
    brand, model, operate_system,      /* 按设备信息分组 */
    version_code, channel;             /* 按应用信息分组 */

/*
 * 数据处理说明:
 *
 * 1. 增量处理模式:
 *    - 只处理当天数据: 筛选特定日期的页面访问数据，减少处理量
 *    - 每日更新: 确保每日数据及时入库，支持实时分析
 *    - 数据隔离: 不同日期的数据互不影响，便于数据回滚和修复
 *
 * 2. 数据来源与处理:
 *    - 数据来源: 从页面浏览事实表获取当日访问数据
 *    - 数据聚合: 按会话和日期分组聚合访问指标
 *    - 指标计算: 计算每个会话的访问时长和页面浏览数
 *
 * 3. 统计指标说明:
 *    - 访问时长: 反映用户单次访问的深度和参与度
 *    - 页面浏览数: 反映用户单次访问的广度和活跃度
 *    - 多维度分组: 支持从设备、应用等维度分析访问行为
 *
 * 4. 性能优化:
 *    - 时间筛选: 通过WHERE条件限定只处理当天数据，减少数据处理量
 *    - 分组优化: 按会话和日期分组，保证统计粒度一致
 *    - 指标计算: 使用高效的聚合函数计算统计指标
 *
 * 5. 应用场景:
 *    - 实时监控: 监控当日会话访问情况和用户行为
 *    - 渠道分析: 评估不同渠道用户的访问质量
 *    - 版本分析: 分析不同版本的用户体验差异
 *    - 设备分析: 分析不同设备的使用场景
 *    - 用户行为: 研究用户的访问路径和偏好
 */